<!DOCTYPE html>
<html>
  <link rel="stylesheet" type="text/css" href="main.css">
  <script src='https://d3js.org/d3.v5.min.js'></script>

  <head>
    <title>CS498: Narrative Visualization</title>
  </head>

  <div class="header">
    <h1>Disparities in Higher Education</h1>
  </div>

  <div class="container">
    <body onload="init()">

    <p>Here's a paragraph, followed by some data.</p>
    <p id="scene_label"></p>

    <p class="graph_elements" id="graph_buttons"></p>
      <div class="drawing">
        <svg>
        </svg>
      </div>

    </body>
  </div>

  <div class="footer">
    <div class="nav">
      <button class="nav_button" id="previous" onclick="">Previous</button>
      <button class="nav_button" id="nav_button" onclick="load_scene_one('tuition')">1</button>
      <button class="nav_button" id="nav_button" onclick="load_scene_two('high_inc')">2</button>
      <button class="nav_button" id="nav_button" onclick="load_scene_three('tuition_by_repay')">3</button>
      <button class="nav_button" id="next" onclick="">Next</button>
    </div>
  </div>    

  <script>
    //------======= ALL SYSTEMS GO ======------//
    let summary_data = null
    async function init() {
      summary_data = await d3.csv('data/preprocessed_summ_vars.csv',
        function(d){
          return {
              year : d3.timeFormat("%Y")(d3.timeParse("%Y")(d.year)),
              meanTuition_byYear : d.meanTuition_byYear,
              meanStateApprop_byYear : d.meanStateApprop_byYear,
              meanRepayRate_byYear : d.meanRepayRate_byYear,
              meanRepayRate_byYearStateAndIncome : d.meanRepayRate_byYearStateAndIncome,
              repay_rate_category : d.repay_rate_category,
              state_abbr : d.state_abbr,
              meanTuition_byState : d.meanTuition_byState,
              meanStateApprop_byState : d.meanStateApprop_byState,
              meanRepayRate_byStateAndIncome : d.meanRepayRate_byStateAndIncome
          }
        }
      );
      load_scene_one('tuition');
    }
    
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function make_button(text, dataset) {
      // create button, add function call
      var graph_button = document.createElement("button");
      graph_button.innerHTML = text;
      graph_button.onclick = function(event) {
        if (dataset == 'tuition' || dataset == 'approp' || dataset == 'repay'){
          return load_scene_one.call(this, dataset);
        } else if (dataset == 'high_inc' || dataset == 'low_inc') {
          return load_scene_two.call(this, dataset);
        } else if (dataset == 'tuition_by_repay' || dataset == 'approp_by_repay') {
          return load_scene_three.call(this, dataset);
        }
      };
      // style
      graph_button.style.fontSize = '12px';
      graph_button.style.padding = '4px 8px';
      graph_button.style.borderRadius = '4px';
      graph_button.style.border = '.5px solid #000000';
      graph_button.style.opacity = '.8';
      return graph_button;
    }

    //=========================================//
    //------======= LOAD SCENE ONE ======------//
    //=========================================//
    async function load_scene_one(dataset){
      // Set scene title
      document.getElementById("scene_label").innerHTML = "This is scene one: ";

      // Set graph buttons for this scene
      document.getElementById("graph_buttons").innerHTML = "";
      document.getElementById("graph_buttons")
          .appendChild(make_button("Tuition", 'tuition'));
      document.getElementById("graph_buttons")
          .appendChild(make_button("State Funding", 'approp'));
      document.getElementById("graph_buttons")
          .appendChild(make_button("Repay Rate", 'repay'));

      // Update nav buttons
      document.getElementById("previous").setAttribute("onclick", "");
      document.getElementById("next").setAttribute("onclick", "load_scene_two('high_inc')");

      // Set SVG vars
      var y_data;
      var y_min;
      if(dataset == 'tuition') {
        y_data = 'meanTuition_byYear';
        y_min = 3000
        y_ax = "Tuition"
      } else if (dataset == 'approp') {
        y_data = 'meanStateApprop_byYear';
        y_min = 60000000
        y_ax = "State Funding"
      } else if (dataset == 'repay') {
        y_data = 'meanRepayRate_byYear';
        y_min = 0.4
        y_ax = "Repayment Rate"
      }
      var height = 350;
      var width = 500;
      var margin = 100;

      // Frame and reset the canvas and create axis vars
      d3.selectAll("svg")
          .attr("width", width + margin * 2)
          .attr("height", height + margin * 2)
          .selectAll("*")
          .remove();
      var x = d3.scaleLinear()
          .domain(d3.extent(summary_data, function(d) { return +d.year }))
          .range([0, width]);
      var y = d3.scaleLinear()
          .domain([y_min, (d3.max(summary_data, function(d) { return +d[y_data]; }) * 1.1 )])
          .range([height, 0]);
      
      // Filter data for the line plot so we have one value per year
      var filtered = summary_data.filter(function(d) { 
            return (d.repay_rate_category == 'repay_rate_hilodiff' && d.state_abbr == 'WI')}
            );
      
      // Get path length for animation
      var path = d3.selectAll("svg").append("g")
          .attr("tranform", "translate(" + margin + ", " + margin + ")")
          .selectAll("path").data(filtered).enter().append("path")
            .attr("fill", "none")
            .attr("stroke", "steelblue")
            .attr("stroke-width", 2)
            .datum(filtered)
            .attr("d", d3.line()
              .x(function(d) { return margin + x(d.year); })
              .y(function(d) { return margin + y(d[y_data]); })
              );
      var path_length = path.node().getTotalLength();
      
      // Draw the line and add axes
      path
        .attr("stroke-dasharray", path_length + " " + path_length)
        .attr("stroke-dashoffset", path_length)
        .transition()
          .duration(1500)
          .ease(d3.easeCubic)
          .delay(1000)
          .attr("stroke-dashoffset", 0);
      d3.selectAll("svg").append("g")
          .attr("transform", "translate(" + margin + "," + (height + margin) + ")")
          .transition()
          .duration(500)
          .call(d3.axisBottom(x).tickFormat(d3.format(".0f")))
          .selectAll(".tick text").attr("font-size", "11");
      d3.selectAll("svg").append("g")
          .attr("transform", "translate(" + margin + ", " + margin +")")
          .transition()
          .duration(500)
          .call(d3.axisLeft(y))
          .selectAll(".tick text").attr("font-size", "11");
      
      // Add x axis label
      d3.selectAll("svg")
          .append("text")
          .attr("transform", "translate(0," + (height + 1.5*margin) + ")")
          .transition()
          .ease(d3.easeBounce)
          .duration(1000)
          .attr("transform", "translate(" + (width/2 + margin) + "," + (height + 1.5*margin) + ")")
          .style("text-anchor", "middle")
          .text("Year");
      // Add y axis label
      d3.selectAll("svg")
          .append("text")
          .attr("transform", "translate(0," + (height + margin) + ")rotate(-90)")
          .transition()
          .ease(d3.easeBounce)
          .duration(1000)
          .attr("y", 0)
          .attr("x", (height/2))
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .text(y_ax);
    }

    //=========================================//
    //------======= LOAD SCENE TWO ======------//
    //=========================================//
    function load_barplot_year(dataset, years, height, width, margin, x, y){
      d3.selectAll("svg").select("g").selectAll("rect").remove();
      var count = 1;
      for (year of years) {
        // Filter data for the bar plot so we have one value per year, state, and income
        var filtered;
        if (dataset == 'high_inc') {
          filtered = summary_data.filter(function(d) { 
              return (d.repay_rate_category == 'repay_rate_highincome' && +d.year == year)}
            );
          y_ax = "Repay Rate (High Income Families)";
        } else if (dataset == 'low_inc') {
          filtered = summary_data.filter(function(d) { 
              return (d.repay_rate_category == 'repay_rate_lowincome' && +d.year == year)}
            );
          y_ax = "Repay Rate (Low Income Families)";
        }
        
        var rates = d3.map(filtered, function(d){return(d.meanRepayRate_byYearStateAndIncome)}).keys();
        if (year == "2007") {
          // Add y axis label
          d3.selectAll("svg")
              .append("text")
              .attr("transform", "translate(0," + (height + margin) + ")rotate(-90)")
              .transition()
              .ease(d3.easeBounce)
              .duration(1000)
              .attr("y", 0)
              .attr("x", (height/2))
              .attr("dy", "1em")
              .style("text-anchor", "middle")
              .text(y_ax);
          // Add header for year
          header = d3.selectAll("svg").append("g")
              .append("text")
              .attr("transform", "translate(" + (width/2 + margin) + "," + 0.5*margin + ")")
              .attr("transform", "translate(" + (width/2 + margin) + "," + 0.5*margin + ")")
              .style("text-anchor", "middle")
              .text(year);
        }
        update = d3.selectAll("svg").select("g").selectAll("rect")
            .data(filtered);
        update.enter().append("rect").merge(update)
            .transition().duration(500).ease(d3.easeLinear)
            .attr("x", function(d) {return x(d.state_abbr);})
            .attr("y", function(d) {return y(d.meanRepayRate_byYearStateAndIncome);})
            .attr("width", x.bandwidth)
            .attr("height", function(d) {return height - y(d.meanRepayRate_byYearStateAndIncome);})
            .attr("fill", "steelblue")
            .delay(count*1500);
        // Transition header
        header.enter().append("text").merge(header)
            .transition()
            .text(year)
            .delay(count*1500);

        count = count + 1;
      }
    }
    async function load_scene_two(dataset){
      // Set scene title
      document.getElementById("scene_label").innerHTML = "This is scene two: ";

      // Set graph buttons for this scene
      document.getElementById("graph_buttons").innerHTML = "";
      document.getElementById("graph_buttons")
          .appendChild(make_button("High Income", 'high_inc'));
      document.getElementById("graph_buttons")
          .appendChild(make_button("Low Income", 'low_inc'));

      // Update nav buttons
      document.getElementById("previous").setAttribute("onclick", "load_scene_one('tuition')");
      document.getElementById("next").setAttribute("onclick", "load_scene_three('tuition_by_repay')");

      // Set SVG vars
      var y_data = 'meanRepayRate_byYearStateAndIncome';
      var y_min = 0.25;
      var height = 350;
      var width = 1000;
      var margin = 100;
      var y_ax;

      // Frame and reset the canvas and create axis vars
      d3.selectAll("svg")
          .attr("width", width + margin * 2)
          .attr("height", height + margin * 2)
          .selectAll("*")
          .remove();
            
      // Get arrays for years and states
      var years = d3.map(summary_data, function(d){return(d.year)}).keys();
      var states = d3.map(summary_data, function(d){return(d.state_abbr)}).keys();
      var x = d3.scaleBand()
          .domain(states)
          .range([0, width])
          .padding(0.1);
      var y = d3.scaleLinear()
          .domain([0.25, 0.9])
          .range([height, 0]);

      // Append new group and transform
      d3.selectAll("svg").append("g")
        .attr("transform","translate("+margin+","+margin+")");
      // Create axes
      d3.selectAll("svg").append("g")
        .attr("transform","translate("+margin+","+margin+")")
        .transition()
        .duration(500)
        .call(d3.axisLeft(y))
        .selectAll(".tick text").attr("font-size", "11");
      d3.selectAll("svg").append("g")
        .attr("transform","translate("+margin+","+(height+margin)+")")
        .transition()
        .duration(500)
        .call(d3.axisBottom(x))
        .selectAll(".tick text").attr("font-size", "11");
      // Add x axis label
      d3.selectAll("svg")
          .append("text")
          .attr("transform", "translate(0," + (height + 1.5*margin) + ")")
          .transition()
          .ease(d3.easeBounce)
          .duration(1000)
          .attr("transform", "translate(" + (width/2 + margin) + "," + (height + 1.5*margin) + ")")
          .style("text-anchor", "middle")
          .text("State");
      load_barplot_year(dataset, years, height, width, margin, x, y);
    }

    //=========================================//
    //------======= LOAD SCENE THREE ======------//
    //=========================================//
    async function load_scene_three(dataset){
      // Set scene title
      document.getElementById("scene_label").innerHTML = "This is scene three: ";

      // Set graph buttons for this scene
      document.getElementById("graph_buttons").innerHTML = "";
      document.getElementById("graph_buttons")
          .appendChild(make_button("Tuition", 'tuition_by_repay'));
      document.getElementById("graph_buttons")
          .appendChild(make_button("State Funding", 'approp_by_repay'));

      // Update nav buttons
      document.getElementById("previous").setAttribute("onclick", "load_scene_two('high_inc')");
      document.getElementById("next").setAttribute("onclick", "");

      // Set SVG vars
      var x_min = 0;
      var x_max = 0.4;
      var y_min = 0;
      var y_max = 0.4;
      var height = 350;
      var width = 500;
      var margin = 100;
      var y_data;
      var y_ax;

      if(dataset == 'tuition_by_repay') {
        y_data = 'meanTuition_byState';
        y_ax = "Tuition"
      } else if (dataset == 'approp_by_repay') {
        y_data = 'meanStateApprop_byState';
        y_ax = "State Funding ($)"
      }

      // Frame and reset the canvas and create axis vars
      d3.selectAll("svg")
          .attr("width", width + margin * 2)
          .attr("height", height + margin * 2)
          .selectAll("*")
          .remove();

      var x = d3.scaleLinear()
          .domain([x_min, x_max])
          .range([0, width]);
      var y = d3.scaleLinear()
          .domain([y_min, (d3.max(summary_data, function(d) { return +d[y_data]; }) * 1.1 )])
          .range([height, 0]);

      // Filter data for the scatter plot so we have one value per state
      var filtered = summary_data.filter(function(d) { 
            return (d.repay_rate_category == 'repay_rate_hilodiff' && +d.year == 2014);
            });

      update = d3.selectAll("svg").append("g")
          .attr("transform","translate("+margin+","+margin+")")
          .selectAll("circle").data(filtered).enter().append("circle")
          .attr("fill", "steelblue")
          .attr("stroke", "blue");
      update.enter().append("circle").merge(update)
          .transition().delay(800).duration(800).ease(d3.easeCubic)
          .attr("cx", function(d) {return x(d.meanRepayRate_byStateAndIncome);})
          .attr("cy", function(d) {return y(+d[y_data]);})
          .attr("r", function(d) {return 3;});

      // Create axes
      d3.selectAll("svg").append("g")
          .attr("transform","translate("+margin+","+margin+")")
          .transition().duration(500)
          .call(d3.axisLeft(y))
          .selectAll(".tick text").attr("font-size", "11");
      d3.selectAll("svg").append("g")
          .attr("transform","translate("+margin+","+(height+margin)+")")
          .transition().duration(500)
          .call(d3.axisBottom(x))
          .selectAll(".tick text").attr("font-size", "11");

      // Add x axis label
      d3.selectAll("svg")
          .append("text")
          .attr("transform", "translate(0," + (height + 1.5*margin) + ")")
          .transition()
          .ease(d3.easeBounce)
          .duration(1000)
          .attr("transform", "translate(" + (width/2 + margin) + "," + (height + 1.5*margin) + ")")
          .style("text-anchor", "middle")
          .text("Difference in Repayment Rate (High vs. Low Income)");
      // Add y axis label
      d3.selectAll("svg")
          .append("text")
          .attr("transform", "translate(0," + (height + margin) + ")rotate(-90)")
          .transition()
          .ease(d3.easeBounce)
          .duration(1000)
          .attr("y", 0)
          .attr("x", (height/2))
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .text(y_ax);

    }

    // async function print_state_abbreviations_and_wait(){
    //   var states = d3.map(summary_data, function(d){return(d.state_abbr)}).keys();
    //   document.getElementById("scene_label").innerHTML = "This is scene one: ";
    //   d3.selectAll("svg")
    //       .attr("width", 1000)
    //       .attr("height", 1000)
    //   d3.selectAll("svg").append("g")
    //       .selectAll("text").data(states).enter().append("text")
    //       .attr("x", function(d, i) { return 15; })
    //       .attr("y", function(d, i) { return 15 + i * 20; })
    //       .attr("fill", "black")
    //       .text( function (d) { return d; });
    //   //await sleep(1000);
    // }

  </script>

</html>
